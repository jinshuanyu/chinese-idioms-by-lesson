<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>生字🔗筆順練習🔗成語</title>
  <style>
    :root{
      --bg:#fffefb;
      --fg:#1b1b1b;
      --accent:#ff7a59;
      --accent-2:#ffd9cc;
      --muted:#6b7280; 
      --card:#ffffff;
      --border:#e5e7eb;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.6 ui-sans-serif,system-ui,"Noto Sans TC",PingFangTC,"Microsoft JhengHei",sans-serif;}
    header{padding:20px 16px 8px; text-align:center;}
    header h1{margin:0; font-size:22px; letter-spacing:.5px;}
    header p.sub{margin:6px 0 0; color:var(--muted); font-size:14px;}
    .container{max-width:960px; margin:0 auto; padding:16px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.04);}
    .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:14px;}
    label{font-weight:600; margin-right:6px;}
    /* 下拉選單字體加大 */
    select{min-width:140px; padding:8px 10px; border-radius:12px; border:1px solid var(--border); background:#fff; font-size:18px;}
    #meta{margin:10px 0 6px; font-size:15px;}
    #meta a{color:#0d6efd; text-decoration:none; border-bottom:1px dotted #9bbcff;}
    #meta .note{color:var(--muted); font-size:13px; margin-left:6px;}

    /* 表格與欄位調整 */
    table{width:100%; border-collapse:collapse; margin-top:8px;}
    th, td{border-bottom:1px solid var(--border); padding:10px 8px; text-align:left;}
    th{background:#fff; position:sticky; top:0;}
    /* 生字欄更窄、字再大一點點 */
    #result th:first-child{width:6rem;}
    #result td.char{font-size:24px; font-weight:700; letter-spacing:2px; white-space:nowrap;}
    /* 成語欄吃剩餘寬度、字體更大 */
    #result thead th{ font-size:17px; }
    #result td.idioms{font-size:20px; line-height:1.9;}

    td a{color:#0d6efd; text-decoration:none;}
    .muted{color:var(--muted); font-size:12px;}
    footer{max-width:960px; margin:12px auto 36px; padding:0 16px; text-align:center;}
    .pill{display:inline-block; background:var(--accent-2); color:#9a3412; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px;}
  </style>
</head>
<body>
  <header>
    <h1>生字🔗筆順練習🔗成語</h1>
    <p class="sub">⏬ 選 <b>學期</b> → <b>年級</b> → <b>版本</b> → <b>課別</b> <br> 🔍 查看生字的筆順和成語連結</p>
  </header>

  <div class="container">
    <div class="card">
      <div class="row">
        <select id="term"></select>
        <select id="grade"></select>
        <select id="publisher"></select>
        <select id="lesson"></select>
        <span id="stats" class="pill"></span>
      </div>

      <div id="meta"></div>

      <table id="result">
        <thead>
          <tr><th>生字</th><th>《成語典》</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<footer id="legal">
  <small>
    生字清單來自教育雲「教育百科」
    （<a href="https://pedia.cloud.edu.tw/Home/CopyRight" target="_blank" rel="noopener">版權說明</a>）；
                                                                                                    
    成語檢索連結至教育部《成語典》
    （<a href="https://dict.idioms.moe.edu.tw/pageView.jsp?ID=44&la=0&webMd=2" target="_blank" rel="noopener">著作權</a>／
    <a href="https://language.moe.gov.tw/001/Upload/Files/site_content/M0001/respub/idiomsdict_10409.pdf" target="_blank" rel="noopener">授權條款</a>）；筆順練習連結至教育部《國字標準字體筆順學習網》（<a href="https://stroke-order.learningweb.moe.edu.tw/page.jsp?ID=52" target="_blank" rel="noopener">版權說明</a>）。
    各連結頁內容與權利皆屬原網站所有。
  </small>
</footer>

<style>
  #legal{margin-top:16px;padding-top:12px;border-top:1px dashed #ddd;color:#555}
  #legal small{font-size:12px;line-height:1.6}
  #legal a{text-decoration:underline}
</style>

<script>
// ===== 設定：學期、出版商、年級碼 =====
const TERMS = [
  { label:"114 學年上學期", code:"11401" }
];
const PUB_CODE = { "南一":"0102", "康軒":"0103", "翰林":"0101" };
const GRADE_CODE = { "一年級":"01","二年級":"02","三年級":"03","四年級":"04","五年級":"05","六年級":"06" };

// ===== CATALOG：完整佔位（命名規範：data/11401/data_11401_<出版社>_<年級>.json） =====
const CATALOG = {
  "114 學年上學期": {
    "一年級": {
      "康軒": "data/11401/data_11401_康軒_一年級.json",
      "南一": "data/11401/data_11401_南一_一年級.json",
      "翰林": "data/11401/data_11401_翰林_一年級.json"
    },
    "二年級": {
      "康軒": "data/11401/data_11401_康軒_二年級.json",
      "南一": "data/11401/data_11401_南一_二年級.json",
      "翰林": "data/11401/data_11401_翰林_二年級.json"
    },
    "三年級": {
      "康軒": "data/11401/data_11401_康軒_三年級.json",
      "南一": "data/11401/data_11401_南一_三年級.json",
      "翰林": "data/11401/data_11401_翰林_三年級.json"
    },
    "四年級": {
      "康軒": "data/11401/data_11401_康軒_四年級.json",
      "南一": "data/11401/data_11401_南一_四年級.json",
      "翰林": "data/11401/data_11401_翰林_四年級.json"
    },
    "五年級": {
      "康軒": "data/11401/data_11401_康軒_五年級.json",
      "南一": "data/11401/data_11401_南一_五年級.json",
      "翰林": "data/11401/data_11401_翰林_五年級.json"
    },
    "六年級": {
      "康軒": "data/11401/data_11401_康軒_六年級.json",
      "南一": "data/11401/data_11401_南一_六年級.json",
      "翰林": "data/11401/data_11401_翰林_六年級.json"
    }
  }
};

// ===== 工具函式 =====
const $ = sel => document.querySelector(sel);
function termCode(label){ const t=TERMS.find(x=>x.label===label); return t ? t.code : ""; }
function parseTerm(label){
  if(!label) return {year:0, sem:1};
  let idx = label.indexOf('學年度');
  if(idx < 0) idx = label.indexOf('學年'); // 兼容「學年」寫法
  const year = idx>0 ? parseInt(label.slice(0, idx).trim(), 10) : 0;
  const sem = (label.includes('上學期')||label.includes('第一學期')) ? 1 : 2;
  return {year, sem};
}
function termsSortedDesc(){
  return TERMS.map(t=>t.label).sort((a,b)=>{
    const A=parseTerm(a), B=parseTerm(b);
    if(B.year!==A.year) return B.year-A.year;
    return B.sem-A.sem;
  });
}
function lessonNo2(label){
  const m = label.match(/^第(\d{1,2})課/);
  return m ? m[1].padStart(2,'0') : '01';
}
function idiomLink(ch){ return `https://dict.idioms.moe.edu.tw/idiomList.jsp?idiom=${encodeURIComponent(ch)}`; }
function expectedLessonsCount(grade, pub){
  if(grade==='一年級'){ return (pub==='康軒') ? 6 : 7; }
  return 12;
}
function pediaId(termLabel, gradeLabel, pubLabel, lessonLabel){
  const pub = PUB_CODE[pubLabel] || "";
  const grade = GRADE_CODE[gradeLabel] || "";
  const tcode = termCode(termLabel) || "";
  const les = lessonNo2(lessonLabel);
  return `${pub}${grade}${tcode}${les}`;
}

// ===== 載入 JSON（無 FALLBACK 生字；抓不到就回空物件） =====
const CACHE = new Map();
async function ensureDataset(term, grade, pub){
  const key = `${term}|${grade}|${pub}`;
  if(CACHE.has(key)) return CACHE.get(key);
  let data = {};
  const url = (CATALOG?.[term]?.[grade]?.[pub]) || (CATALOG?.[termCode(term)]?.[grade]?.[pub]);
  if(url){
    try{
      const res = await fetch(encodeURI(url), {cache:'no-cache'});
      if(res.ok) data = await res.json();
    }catch(e){}
  }
  CACHE.set(key, data);
  return data;
}

// ===== UI：初始化與事件 =====
function resetSelect(id){ $(id).innerHTML = '<option value="">—</option>'; }

function init(){
  const termSel = $('#term');
  termSel.innerHTML = termsSortedDesc().map(x=>`<option>${x}</option>`).join('');
  termSel.value = "114 學年上學期";
  updateGrades();
}

function updateGrades(){
  resetSelect('#grade'); resetSelect('#publisher'); resetSelect('#lesson');
  $('#meta').textContent=''; $('#stats').textContent='';
  const term=$('#term').value;
  const grades = term ? Object.keys(CATALOG[term] || CATALOG[termCode(term)] || {}) : [];
  $('#grade').innerHTML = '<option value="">— 請選擇年級 —</option>' + grades.map(g=>`<option>${g}</option>`).join('');
}

function updatePublishers(){
  resetSelect('#publisher'); resetSelect('#lesson');
  $('#meta').textContent=''; $('#stats').textContent='';
  const term=$('#term').value, grade=$('#grade').value;
  const pubs = (term && grade) ? Object.keys((CATALOG[term] || CATALOG[termCode(term)] || {})[grade] || {}) : [];
  $('#publisher').innerHTML = '<option value="">— 請選擇版本 —</option>' + pubs.map(p=>`<option>${p}</option>`).join('');
}

async function updateLessons(){
  resetSelect('#lesson'); $('#meta').textContent=''; $('#stats').textContent='';
  const term=$('#term').value, grade=$('#grade').value, pub=$('#publisher').value;
  if(!term || !grade || !pub) return;
  const data = await ensureDataset(term, grade, pub);
  window.CURRENT_DATA = data;
  let lessons = Object.keys(data||{});
  if(!lessons.length){
    const n = expectedLessonsCount(grade, pub);
    lessons = Array.from({length:n}, (_,i)=>`第${String(i+1).padStart(2,'0')}課`);
  }
  lessons.sort((a,b)=> (parseInt(lessonNo2(a),10) - parseInt(lessonNo2(b),10)) );
  $('#lesson').innerHTML = '<option value="">— 請選擇課別 —</option>' + lessons.map(l=>`<option>${l}</option>`).join('');
}

function render(){
  const term=$('#term').value, grade=$('#grade').value, pub=$('#publisher').value, les=$('#lesson').value;
  $('#result tbody').innerHTML='';
  if(!term || !grade || !pub || !les) { $('#meta').textContent=''; $('#stats').textContent=''; return; }
  const chars = (window.CURRENT_DATA||{})[les] || [];
  const id = pediaId(term, grade, pub, les);
  const lessonURL = `https://pedia.cloud.edu.tw/Bookmark/TCollection?TextNameId=${id}`;
  $('#meta').innerHTML = `<strong>${term}</strong>｜<strong>${grade}</strong>｜<strong>${pub}</strong> <br> <a href="${lessonURL}" target="_blank" rel="noopener">📖 ${les}</a> <br> <span class="note">《教育百科》生字詞彙表</span>`;
  (function(){
    const strokeText = encodeURIComponent(chars.join(''));
    const strokeURL = `https://stroke-order.learningweb.moe.edu.tw/searchW.jsp?WORD=${strokeText}&la=0`;
    $('#meta').insertAdjacentHTML('beforeend', `<br><a href="${strokeURL}" target="_blank" rel="noopener">✍️ 筆順練習</a><span class="note"> <br> 教育部國字標準字體筆順學習網</span>`);
  })();
  $('#stats').textContent = chars.length ? `　共 ${chars.length} 個生字` : '';
  const tbody = $('#result tbody');
  for(const ch of chars){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="char">${ch}</td><td class="idioms"><a href="${idiomLink(ch)}" target="_blank" rel="noopener">成語檢索「${ch}」</a></td>`;
    tbody.appendChild(tr);
  }
}

// 綁定
$('#term').addEventListener('change', ()=>{ updateGrades(); });
$('#grade').addEventListener('change', ()=>{ updatePublishers(); });
$('#publisher').addEventListener('change', async ()=>{ await updateLessons(); });
$('#lesson').addEventListener('change', render);

// 啟動
init();
</script>
</body>
</html>
